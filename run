#!/bin/zsh

ListGen=(net net/filter)

# get options
while getopts "aigo" opt; do
  case $opt {
  a) OptAct=true ;; # run once
  i) OptIni=true ;; # install
  g) OptGen=true ;; # generate
  o) OptOut=true ;; # output
  }
done

# install dependencies
if [[ -n $OptIni || -n $OptAct ]] {
  varPkg=(zsh git python3)
  varPip=(pyyaml requests)
  # linux
  if [[ -x $(command -v brew) ]]; then
    brew install -y $varPkg
  elif [[ -x $(command -v apt-get) ]]; then
    sudo apt install -y $varPkg
  elif [[ -x $(command -v dnf) ]]; then
    sudo dnf install -y $varPkg
  else
    echo $varPkg
  fi
  # python
  python3 -m pip install $varPip
}

# install git config
if [[ -n $OptIni && -z $OptAct ]] {
  git submodule update --init --recursive
  git worktree add out etc
  wait
  # check branch
  cd doc
  git checkout -qf master
  cd ../out
  git checkout -qf etc
  git pull -q --rebase
  cd ..
}

# generate files
if [[ -n $OptGen || -n $OptAct ]] {
  cp -rf src/out .
  cp -f LICENSE out/LICENSE
  for item in ${ListGen[@]}; {
    python3 src/$item/main.py
  }
}

# release output
if [[ -n $OptOut && -z $OptAct ]]  {
  cd out
  git add --all
  git commit -qm gen --amend --reset-author
  git push -qf
  cd ..
}
