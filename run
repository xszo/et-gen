#!/bin/zsh

ListGen=(net net/filter)

# get options
while getopts "aigo" opt; do
  case $opt {
  a) OptAct=true ;; # run once
  i) OptIni=true ;; # install
  g) OptGen=true ;; # generate
  o) OptOut=true ;; # publish
  }
done

# install dependencies
if [[ -n $OptIni || -n $OptAct ]] {
  # install linux packages
  varPkg=(zsh git python3 python3-pip)
  if [[ -x $(command -v brew) ]]; then
    brew install -y $varPkg
  elif [[ -x $(command -v apt-get) ]]; then
    sudo apt install -y $varPkg
  elif [[ -x $(command -v dnf) ]]; then
    sudo dnf install -y $varPkg
  elif [[ -x $(command -v yum) ]]; then
    sudo yum install -y $varPkg
  else
    echo $varPkg
  fi
  # install python packages
  python3 -m pip install -r src/env/pip
}

# install git config
if [[ -n $OptIni && -z $OptAct ]] {
  # init submodule
  git submodule update --init --recursive
  # init worktree
  if ! git worktree list | grep -q "out"; then
    if [[ -e out ]] { rm -rf out; }
    git worktree add out etc
  fi
  # init branch
  wait
  git checkout -qf main
  cd doc
  git checkout -qf master
  cd ../out
  git checkout -qf etc
  git pull -q --rebase
  cd ..
}

# generate output
if [[ -n $OptGen || -n $OptAct ]] {
  cp -rf src/out .
  cp -f LICENSE out/LICENSE
  for item in ${ListGen[@]}; {
    python3 src/$item/main.py
  }
}

# publish output
if [[ -n $OptOut && -z $OptAct ]]  {
  cd out
  git add --all
  git commit -qm gen --amend --reset-author
  git push -qf
  cd ..
}
